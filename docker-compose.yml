version: "3.8"

services:
  redis:
    image: "redis:latest"
    ports:
      - "6379:6379"
    networks:
      - my_network

  postgres:
    image: "gradescope/postgresql-multiple-databases"
    environment:
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "postgres"
      POSTGRES_MULTIPLE_DATABASES: "starhub_server,gitea"
    ports:
      - "5433:5432"
    volumes:
      - ./pgdata:/var/lib/postgresql/data
    networks:
      - my_network

  gitea:
    image: "git-devops.opencsg.com:5050/product/community/starhub-server/gitea-bitnami"
    depends_on:
      - postgres
      - redis
    environment:
      - GITEA_ROOT_URL=$GITEA_ROOT_URL
      - GITEA_HTTP_PORT=3001
      - GITEA_ADMIN_USER=root
      - GITEA_ADMIN_PASSWORD=password123
      - GITEA_ADMIN_EMAIL=root@opencsg.com
      - GITEA_DATABASE_TYPE=postgres
      - GITEA_DATABASE_HOST=postgres
      - GITEA_DATABASE_PORT_NUMBER=5432
      - GITEA_DATABASE_NAME=gitea
      - GITEA_DATABASE_USERNAME=postgres
      - GITEA_DATABASE_PASSWORD=postgres
      - GITEA_DATABASE_SSL_MODE=disable
      - GITEA_APP_NAME=gitea
      - GITEA_SMTP_ENABLED=false
      - BITNAMI_DEBUG=true
      - GITEA_LFS_START_SERVER=true
      - GITEA_LFS_ROOT_PATH=/bitnami/gitea/data/lfs
      - GITEA_LFS_STORAGE_TYPE=minio
      - GITEA_LFS_MINIO_ACCESS_KEY_ID=$GITEA_LFS_MINIO_ACCESS_KEY_ID
      - GITEA_LFS_MINIO_SECRET_ACCESS_KEY=$GITEA_LFS_MINIO_SECRET_ACCESS_KEY
      - GITEA_LFS_MINIO_ENDPOINT=$GITEA_LFS_MINIO_ENDPOINT
      - GITEA_LFS_MINIO_BUCKET=opencsg-test
      - GITEA_LFS_MINIO_LOCATION=cn-beijing
      - GITEA_LFS_MINIO_USE_SSL=true
      - GITEA_LFS_SERVE_DIRECT=true
      - GITEA_SERVICE_DEFAULT_ALLOW_CREATE_ORGANIZATION=true
    ports:
      - "3001:3001"
      - "2222:2222"
    volumes:
      - ./gitea:/bitnami/gitea
    networks:
      - my_network

  starhub_server:
    image: "git-devops.opencsg.com:5050/product/community/starhub-server"
    depends_on:
      - postgres
      - redis
      - gitea
    environment:
      STARHUB_DATABASE_DSN: postgresql://postgres:postgres@postgres:5432/starhub_server?sslmode=disable
      STARHUB_DATABASE_TIMEZONE: Asia/Shanghai
      STARHUB_SERVER_REDIS_ENDPOINT: redis:6379
      STARHUB_SERVER_GITSERVER_HOST: http://gitea:3001
      STARHUB_SERVER_GITSERVER_USERNAME: root
      STARHUB_SERVER_GITSERVER_PASSWORD: password123
      STARHUB_SERVER_GITSERVER_WEBHOOK_URL: http://localhost:8080/api/v1/callback/git
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: starhub_server
      GITEA_USERNAME: root
      GITEA_PASSWORD: password123
      GIN_MODE: release
      STARHUB_SERVER_API_TOKEN: $STARHUB_SERVER_API_TOKEN
      STARHUB_SERVER_ALIYUN_ACCESS_KEY_ID: $STARHUB_SERVER_ALIYUN_ACCESS_KEY_ID
      STARHUB_SERVER_ALIYUN_ACCESS_KEY_SECRET: $STARHUB_SERVER_ALIYUN_ACCESS_KEY_SECRET
      STARHUB_SERVER_ALIYUN_REGION: $STARHUB_SERVER_ALIYUN_REGION
    ports:
      - "8080:8080"
    networks:
      - my_network

networks:
  my_network:
    driver: bridge