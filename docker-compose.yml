version: "3.8"

services:
  postgres:
    image: "gradescope/postgresql-multiple-databases:14.4"
    environment:
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "postgres"
      POSTGRES_MULTIPLE_DATABASES: "starhub_server,gitea,mirror"
    ports:
      - "5433:5432"
    volumes:
      - ./pgdata:/var/lib/postgresql/data
    networks:
      - my_network

  memmachine_postgres:
    image: docker.io/pgvector/pgvector:pg16
    environment:
      POSTGRES_DB: "memmachine"
      POSTGRES_USER: "memmachine"
      POSTGRES_PASSWORD: "memmachine_password"
    ports:
      - "5433:5432"
    healthcheck:
      test: pg_isready -U memmachine -h 127.0.0.1
      interval: 5s
    volumes:
      - ./data/memmachine/pgdata:/var/lib/postgresql/data
    networks:
      - my_ce_network

  memmachine_neo4j:
    image: docker.io/neo4j:5.23-community
    environment:
      NEO4J_AUTH: "neo4j/neo4j_password"
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - ./data/memmachine/neo4j/data:/data
      - ./data/memmachine/neo4j/logs:/logs
      - ./data/memmachine/neo4j/import:/var/lib/neo4j/import
      - ./data/memmachine/neo4j/plugins:/plugins
    networks:
      - my_ce_network

  memmachine:
    image: memmachine/memmachine:v0.2.3-cpu
    depends_on:
      - memmachine_postgres
      - memmachine_neo4j
    environment:
      POSTGRES_HOST: memmachine_postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: "memmachine"
      POSTGRES_PASSWORD: "memmachine_password"
      POSTGRES_DB: "memmachine"
      NEO4J_HOST: memmachine_neo4j
      NEO4J_PORT: "7687"
      NEO4J_USER: "neo4j"
      NEO4J_PASSWORD: "neo4j_password"
      MEMORY_CONFIG: /app/configuration.yml
      HOST: 0.0.0.0
    ports:
      - "8081:8080"
    volumes:
      - ./data/memmachine/configuration.yml:/app/configuration.yml:ro
      - ./data/memmachine/logs:/tmp/memory_logs
    networks:
      - my_ce_network

  minio:
    image: "bitnami/minio"
    environment:
      MINIO_ROOT_USER: "minio-root-user-User-123"
      MINIO_ROOT_PASSWORD: "minio-root-password-User-123"
      MINIO_SCHEME: "http"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - ./minio_data:/bitnami/minio/data
    networks:
      - my_network

  redis:
    image: "redis"
    ports:
      - "6379:6379"
    networks:
      - my_network

  gitea:
    image: "opencsg/csghub-git"
    depends_on:
      - postgres
    environment:
      - GITEA_DAEMON_USER=git
      - GITEA_ROOT_URL=$GITEA_ROOT_URL
      - GITEA_SSH_DOMAIN=$GITEA_SSH_DOMAIN
      - GITEA_HTTP_PORT=3001
      - GITEA_ADMIN_USER=root
      - GITEA_ADMIN_PASSWORD=password123
      - GITEA_ADMIN_EMAIL=root@opencsg.com
      - GITEA_DATABASE_TYPE=postgres
      - GITEA_DATABASE_HOST=postgres
      - GITEA_DATABASE_PORT_NUMBER=5432
      - GITEA_DATABASE_NAME=gitea
      - GITEA_DATABASE_USERNAME=postgres
      - GITEA_DATABASE_PASSWORD=postgres
      - GITEA_DATABASE_SSL_MODE=disable
      - GITEA_APP_NAME=gitea
      - GITEA_SMTP_ENABLED=false
      - BITNAMI_DEBUG=true
      - GITEA_LFS_START_SERVER=true
      - GITEA_LFS_ROOT_PATH=/bitnami/gitea/data/lfs
      - GITEA_LFS_STORAGE_TYPE=minio
      - GITEA_LFS_MINIO_ACCESS_KEY_ID=minio-root-user-User-123
      - GITEA_LFS_MINIO_SECRET_ACCESS_KEY=minio-root-password-User-123
      - GITEA_LFS_MINIO_ENDPOINT=minio:9000
      - GITEA_LFS_MINIO_BUCKET=opencsg-server-lfs
      - GITEA_LFS_MINIO_LOCATION=beijing
      - GITEA_LFS_MINIO_USE_SSL=false
      - GITEA_LFS_SERVE_DIRECT=true
      - GITEA_SERVICE_DEFAULT_ALLOW_CREATE_ORGANIZATION=true
    ports:
      - "3001:3001"
      - "2222:2222"
    volumes:
      - ./gitea:/bitnami/gitea
    networks:
      - my_network

  mirror:
    image: "opencsg/csghub-git"
    depends_on:
      - postgres
    environment:
      - GITEA_DAEMON_USER=git
      - GITEA_ROOT_URL=$GITEA_MIRROR_ROOT_URL
      - GITEA_SSH_DOMAIN=$GITEA_MIRROR_SSH_DOMAIN
      - GITEA_HTTP_PORT=3001
      - GITEA_ADMIN_USER=root
      - GITEA_ADMIN_PASSWORD=password123
      - GITEA_ADMIN_EMAIL=root@opencsg.com
      - GITEA_DATABASE_TYPE=postgres
      - GITEA_DATABASE_HOST=postgres
      - GITEA_DATABASE_PORT_NUMBER=5432
      - GITEA_DATABASE_NAME=mirror
      - GITEA_DATABASE_USERNAME=postgres
      - GITEA_DATABASE_PASSWORD=postgres
      - GITEA_DATABASE_SSL_MODE=disable
      - GITEA_APP_NAME=gitea
      - GITEA_SMTP_ENABLED=false
      - BITNAMI_DEBUG=true
      - GITEA_LFS_START_SERVER=true
      - GITEA_LFS_ROOT_PATH=/bitnami/gitea/data/lfs
      - GITEA_LFS_STORAGE_TYPE=minio
      - GITEA_LFS_MINIO_ACCESS_KEY_ID=minio-root-user-User-123
      - GITEA_LFS_MINIO_SECRET_ACCESS_KEY=minio-root-password-User-123
      - GITEA_LFS_MINIO_ENDPOINT=minio:9000
      - GITEA_LFS_MINIO_BUCKET=opencsg-server-lfs
      - GITEA_LFS_MINIO_LOCATION=beijing
      - GITEA_LFS_MINIO_USE_SSL=false
      - GITEA_LFS_SERVE_DIRECT=true
      - GITEA_SERVICE_DEFAULT_ALLOW_CREATE_ORGANIZATION=true
    ports:
      - "3002:3002"
    volumes:
      - ./mirror:/bitnami/gitea
    networks:
      - my_network

  natsmaster:
    image: "nats:2.10.16"
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '1'
          memory: 1G
    ports:
      - "4222:4222"
      - "6222:6222"
      - "8222:8222"
    volumes:
      - ./nats-server.conf:/nats-server.conf
      - ./jetstream:/data/jetstream
    restart: always
    networks:
      - my_ce_network

  temporal:
    depends_on:
      - postgres
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=postgres
      - POSTGRES_PWD=postgres
      - DEFAULT_NAMESPACE_RETENTION=7d
      - POSTGRES_SEEDS=postgres
    # uncomment to use docker hub
    # image: temporalio/auto-setup:1.25.1
    image: opencsg-registry.cn-beijing.cr.aliyuncs.com/opencsg_public/temporalio/auto-setup:1.25.1
    ports:
      - 7233:7233
    networks:
      - my_ce_network

  temporal-ui:
    depends_on:
      - temporal
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:3000
    # uncomment to use docker hub
    # image: temporalio/ui:2.30.3
    image: opencsg-registry.cn-beijing.cr.aliyuncs.com/opencsg_public/temporalio/ui:2.30.3
    ports:
      - 8180:8080
    networks:
      - my_ce_network

  loki:
    image: opencsg-registry.cn-beijing.cr.aliyuncs.com/opencsg_public/grafana/loki:3.1.0
    container_name: loki
    restart: unless-stopped
    command:
      - "-config.file=/etc/loki/loki-config.yaml"
    ports:
      - "3100:3100"
    volumes:
      - ./data/loki-data:/data
      - ./data/loki-config.yaml:/etc/loki/loki-config.yaml
    networks:
      - my_ce_network

  # default user: root/Root@1234
  casdoor:
    image: opencsg-registry.cn-beijing.cr.aliyuncs.com/opencsg_public/casbin/casdoor:v1.733.0
    depends_on:
      postgres:
        condition: service_healthy
        restart: true
    environment:
      RUNNING_IN_DOCKER: true
    volumes:
      - ./data/casdoor/conf:/conf
    restart: always
    healthcheck:
      test: [ "CMD", "nc", "-z", "localhost", "8000" ]
      interval: 10s
      timeout: 10s
      retries: 30
    networks:
      - my_ce_network

  starhub_server:
    image: opencsg-registry.cn-beijing.cr.aliyuncs.com/opencsghq/csghub-server:latest
    depends_on:
      - postgres
      - memmachine
      - gitaly
      - minio
      - redis
      - natsmaster
      - temporal
      - loki
    entrypoint:
      - /starhub-bin/starhub
      - start
      - server
      - "--config=/starhub-bin/config/config.toml"
    ports:
      - "8080:8080"
    volumes:
      - ./data/config.toml:/starhub-bin/config/config.toml:r
    networks:
      - my_ce_network

  user_server:
    image: opencsg-registry.cn-beijing.cr.aliyuncs.com/opencsghq/csghub-server:latest
    entrypoint:
      - /starhub-bin/starhub
      - user
      - launch
      - "--config=/starhub-bin/config/config.toml"
    depends_on:
      - postgres
      - starhub_server
    ports:
      - "8088:8088"
    volumes:
      - ./data/casdoor/:/starhub-bin/casdoor/:r
      - ./data/config.toml:/starhub-bin/config/config.toml:r
    networks:
      - my_ce_network

  account_server:
    image: "opencsg-registry.cn-beijing.cr.aliyuncs.com/opencsg_public/csghub_server:latest"
    entrypoint:
      - /starhub-bin/starhub
      - accounting
      - launch
    depends_on:
      - postgres
      - natsmaster
    environment:
      STARHUB_SERVER_API_TOKEN: $STARHUB_SERVER_API_TOKEN
      STARHUB_DATABASE_DSN: postgresql://postgres:postgres@postgres:5432/starhub_server?sslmode=disable
      OPENCSG_ACCOUNTING_SERVER_PORT: 8086
      OPENCSG_ACCOUNTING_NATS_URL: nats://natsadmin:vf3jv9SsJBdv3n02n8Kxbvjf@natsmaster:4222
      OPENCSG_ACCOUNTING_FEE_EVENT_SUBJECT: "accounting.fee.>"
      OPENCSG_ACCOUNTING_NOTIFY_NOBALANCE_SUBJECT: "accounting.notify.nobalance"
      OPENCSG_ACCOUNTING_MSG_FETCH_TIMEOUTINSEC: 5
      GIN_MODE: release
    ports:
      - "8086:8086"
    restart: always

  temporal_worker:
    build:
      context: ./
      dockerfile: docker/Dockerfile-saas
      args:
        CSGHUB_TAGS: ${CSGHUB_TAGS}
    entrypoint:
      - /starhub-bin/starhub
      - temporal-worker
      - launch
      - --config=/starhub-bin/config/config.toml
    restart: always
    volumes:
      - ./common/config/local.toml:/starhub-bin/config/config.toml:r

networks:
  my_network:
    driver: bridge

